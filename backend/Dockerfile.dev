# Development Dockerfile for NestJS Backend
# Use Debian-based image for better Prisma/OpenSSL compatibility
FROM node:20-slim

WORKDIR /app

# Accept build arguments for user/group IDs (defaults to 1000 if not provided)
ARG HOST_UID=1000
ARG HOST_GID=1000

# Install dependencies for development
RUN apt-get update && \
    apt-get install -y --no-install-recommends git openssl ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Create non-root user with host user's UID/GID
# Try to create group, ignore error if it already exists
RUN groupadd -g ${HOST_GID} nodejs 2>/dev/null || \
    (getent group ${HOST_GID} >/dev/null && echo "Group ${HOST_GID} already exists") || true

# Try to create user, ignore error if it already exists  
RUN useradd -r -u ${HOST_UID} -g ${HOST_GID} nestjs 2>/dev/null || \
    (getent passwd ${HOST_UID} >/dev/null && echo "User ${HOST_UID} already exists") || \
    (useradd -r -u ${HOST_UID} -g nodejs nestjs 2>/dev/null && echo "Created nestjs user") || \
    echo "Using existing user with UID ${HOST_UID}"

# Copy package files
COPY package*.json ./
COPY tsconfig.json ./
COPY nest-cli.json ./

# Install all dependencies
# Add retry logic for network issues and configure npm for better reliability
RUN npm config set fetch-retries 5 && \
    npm config set fetch-retry-mintimeout 20000 && \
    npm config set fetch-retry-maxtimeout 120000 && \
    npm ci || \
    (echo "First npm ci attempt failed, retrying in 5 seconds..." && sleep 5 && npm ci) || \
    (echo "Second npm ci attempt failed, retrying in 10 seconds..." && sleep 10 && npm ci)

# Copy source code (use numeric UID/GID to avoid user lookup issues)
COPY --chown=${HOST_UID}:${HOST_GID} . .

# Copy entrypoint script
COPY --chown=${HOST_UID}:${HOST_GID} docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Install gosu as su-exec alternative for Debian
RUN apt-get update && \
    apt-get install -y --no-install-recommends gosu && \
    rm -rf /var/lib/apt/lists/* && \
    ln -s /usr/bin/gosu /usr/local/bin/su-exec

# Create dist directory with correct permissions (use numeric UID/GID)
RUN mkdir -p /app/dist && \
    chown -R ${HOST_UID}:${HOST_GID} /app/dist && \
    chmod -R 755 /app/dist

# Expose port
EXPOSE 3001

# Use entrypoint script to handle permissions and Prisma generation
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]

# Start in development mode with watch
CMD ["npm", "run", "dev"]
