// ===================================
// Domain: FrontDesk Operations
// ===================================

enum VisitStatus {
  CHECKED_IN
  IN_TRIAGE
  IN_CONSULTATION
  PROCEDURE_IN_PROGRESS
  RECOVERY
  WAITING_BILLING
  DEPARTED
  CANCELLED
}

enum QueueStatus {
  WAITING
  IN_CONSULTATION
  COMPLETED
  LEFT
}

model ClinicVisit {
  id              String       @id @default(uuid()) @db.Uuid
  patientId       String       @db.Uuid
  appointmentId    String?      @unique @db.Uuid // Linked appointment
  
  checkInAt       DateTime     @default(now()) @db.Timestamptz(6)
  checkOutAt      DateTime?    @db.Timestamptz(6)
  status          VisitStatus  @default(CHECKED_IN)
  
  // Operational details
  providerId      String?      @db.Uuid // Doctor/Nurse seen during visit
  roomNumber      String?      @db.VarChar(50)
  
  // Revenue linkage
  invoiceId       String?      @db.Uuid
  
  // Audit
  createdAt       DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime     @updatedAt @db.Timestamptz(6)
  createdBy       String       @db.Uuid

  // Relations
  patient         Patient      @relation(fields: [patientId], references: [id])
  appointment     Appointment? @relation(fields: [appointmentId], references: [id])
  queueEntry      QueueEntry?
  invoices        Invoice[]
  
  @@index([patientId])
  @@index([status])
  @@index([checkInAt])
  @@map("clinic_visits")
}

model QueueEntry {
  id              String       @id @default(uuid()) @db.Uuid
  visitId         String       @unique @db.Uuid
  patientId       String       @db.Uuid
  priority        Int          @default(0) // 0 = Normal, 1+ = Urgent
  status          QueueStatus  @default(WAITING)
  
  enteredAt       DateTime     @default(now()) @db.Timestamptz(6)
  calledAt        DateTime?    @db.Timestamptz(6)
  completedAt     DateTime?    @db.Timestamptz(6)
  
  // Relations
  visit           ClinicVisit  @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@index([enteredAt])
  @@index([priority])
  @@index([status])
  @@map("queue_entries")
}

// ===================================
// Domain: Appointment Extensions
// ===================================

model AppointmentStatusHistory {
  id              String       @id @default(uuid()) @db.Uuid
  appointmentId    String       @db.Uuid
  fromStatus      String?      @db.VarChar(50)
  toStatus        String       @db.VarChar(50)
  changedAt       DateTime     @default(now()) @db.Timestamptz(6)
  changedBy       String       @db.Uuid
  reason          String?      @db.Text
  
  // Relations
  appointment     Appointment  @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([changedAt])
  @@map("appointment_status_history")
}

// ===================================
// Domain: Advanced Billing
// ===================================

enum InvoiceStatus {
  DRAFT
  ISSUED
  PARTIAL
  PAID
  VOID
  REFUNDED
}

model Invoice {
  id              String       @id @default(uuid()) @db.Uuid
  invoiceNumber   String       @unique @db.VarChar(50)
  patientId       String       @db.Uuid
  visitId         String?      @db.Uuid
  appointmentId    String?      @db.Uuid
  procedurePlanId String?      @db.Uuid
  followUpPlanId  String?      @db.Uuid
  
  totalAmount     Decimal      @db.Decimal(10, 2)
  taxAmount       Decimal      @default(0) @db.Decimal(10, 2)
  discountAmount  Decimal      @default(0) @db.Decimal(10, 2)
  netAmount       Decimal      @db.Decimal(10, 2)
  
  status          InvoiceStatus @default(DRAFT)
  issuedAt        DateTime     @default(now()) @db.Timestamptz(6)
  paidAt          DateTime?    @db.Timestamptz(6)
  
  // Audit
  createdAt       DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime     @updatedAt @db.Timestamptz(6)
  
  // Relations
  patient         Patient      @relation(fields: [patientId], references: [id])
  visit           ClinicVisit? @relation(fields: [visitId], references: [id])
  appointment     Appointment? @relation(fields: [appointmentId], references: [id])
  procedurePlan   ProcedurePlan? @relation(fields: [procedurePlanId], references: [id])
  followUpPlan    FollowUpPlan? @relation(fields: [followUpPlanId], references: [id])
  paymentLogs     PaymentGatewayLog[]

  @@index([patientId])
  @@index([appointmentId])
  @@index([status])
  @@index([invoiceNumber])
  @@map("invoices")
}

model PaymentGatewayLog {
  id              String       @id @default(uuid()) @db.Uuid
  invoiceId       String       @db.Uuid
  gatewayName     String       @db.VarChar(100) // STRIPE, MPESA, CC
  transactionId   String       @unique @db.VarChar(200)
  amount          Decimal      @db.Decimal(10, 2)
  currency        String       @default("KES") @db.VarChar(10)
  
  status          PaymentStatus @default(PENDING)
  rawResponse     Json?        // Full gateway callback payload
  
  createdAt       DateTime     @default(now()) @db.Timestamptz(6)
  
  // Relations
  invoice         Invoice      @relation(fields: [invoiceId], references: [id])

  @@index([transactionId])
  @@index([invoiceId])
  @@map("payment_gateway_logs")
}
